<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Registro Presenze Guide - Autoscuola</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome per le icone -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- html2canvas per salvare l'immagine -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            background-color: #f3f4f6;
            touch-action: pan-y;
        }
        canvas {
            touch-action: none;
            cursor: crosshair;
        }
        /* Stile carta strappata */
        .receipt-edge {
            background-image: linear-gradient(135deg, #ffffff 50%, transparent 50%), linear-gradient(225deg, #ffffff 50%, transparent 50%);
            background-position: bottom;
            background-size: 20px 20px;
            background-repeat: repeat-x;
            height: 20px;
            width: 100%;
            position: absolute;
            bottom: -10px;
            left: 0;
            z-index: 10;
        }
        /* Forza contrasto alto per gli input quando stampati */
        input {
            color: #000000 !important; 
            opacity: 1 !important;
        }
        /* Stile specifico per l'input data header per renderlo bianco */
        #driveDate {
            color: #ffffff !important;
            color-scheme: dark;
        }
        /* Reset colore per input data quando catturato da html2canvas */
        .html2canvas-container #driveDate {
            color: #ffffff !important;
        }
        /* Stile scrollbar suggerimenti */
        #suggestions::-webkit-scrollbar {
            width: 8px;
        }
        #suggestions::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        #suggestions::-webkit-scrollbar-thumb {
            background: #c1c1c1; 
            border-radius: 4px;
        }
    </style>
</head>
<body class="font-sans text-gray-800 min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Header App -->
    <header class="w-full max-w-md mb-6 text-center">
        <h1 class="text-2xl font-bold text-blue-700 uppercase tracking-wider">
            <i class="fa-solid fa-car-side mr-2"></i>DriveCheck
        </h1>
        <p class="text-gray-500 text-sm">Registro digitale guide</p>
    </header>

    <!-- Area principale (Il "Foglio" che verrà salvato) -->
    <main id="capture-area" class="w-full max-w-md bg-white shadow-xl rounded-t-lg relative pb-8 mb-4">
        
        <!-- Intestazione Modulo -->
        <div class="bg-blue-600 p-4 rounded-t-lg text-white flex justify-between items-center">
            <div>
                <h2 class="font-bold text-lg">Modulo Presenza</h2>
                <!-- Data Modificabile -->
                <div class="flex items-center text-blue-100 text-xs mt-1">
                    <span class="mr-2 opacity-80">Data:</span>
                    <input type="date" id="driveDate" class="bg-transparent font-medium focus:outline-none border-b border-blue-400 focus:border-white pb-0.5 cursor-pointer">
                </div>
            </div>
            <i class="fa-solid fa-clipboard-check text-2xl opacity-80"></i>
        </div>

        <div class="p-6 space-y-4">
            <!-- Dati Allievo con Autocomplete -->
            <div class="relative">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ALLIEVO/A</label>
                <div class="relative">
                    <input type="text" id="studentName" placeholder="Cerca o inserisci nome..." autocomplete="off"
                        class="w-full border-b-2 border-gray-200 focus:border-blue-500 outline-none py-2 text-lg font-bold text-black bg-transparent transition-colors">
                    
                    <!-- Icona lente (estetica) -->
                    <i class="fa-solid fa-magnifying-glass absolute right-2 top-3 text-gray-300 pointer-events-none"></i>
                    
                    <!-- Lista suggerimenti -->
                    <ul id="suggestions" class="absolute z-50 w-full bg-white border border-gray-200 shadow-xl rounded-b-lg max-h-60 overflow-y-auto hidden text-sm text-left">
                        <!-- I suggerimenti verranno inseriti qui via JS -->
                    </ul>
                </div>
            </div>

            <!-- Sezione Pagamento -->
            <div class="bg-yellow-50 rounded-lg p-4 border-2 border-yellow-200 space-y-3">
                <div class="flex items-center">
                    <input type="checkbox" id="paymentReceived" class="w-6 h-6 text-blue-600 rounded border-gray-400 focus:ring-blue-500 cursor-pointer">
                    <label for="paymentReceived" class="ml-3 text-gray-900 font-bold cursor-pointer select-none flex items-center uppercase text-sm tracking-wide">
                        <i class="fa-solid fa-hand-holding-dollar mr-2 text-yellow-600 text-lg"></i>
                        Pagamento Ricevuto
                    </label>
                </div>
                
                <div id="paymentAmountContainer" class="pt-2 hidden">
                    <label class="block text-xs font-extrabold text-gray-600 uppercase mb-1">Importo (€)</label>
                    <input type="number" id="paymentAmount" placeholder="0.00" step="0.50"
                        class="w-full bg-white border-2 border-gray-300 rounded px-3 py-3 text-lg focus:border-blue-500 outline-none font-bold text-black shadow-sm placeholder-gray-300">
                </div>
            </div>

            <!-- Area Firma -->
            <div class="mt-6">
                <div class="flex justify-between items-end mb-2">
                    <label class="text-xs font-bold text-gray-500 uppercase">Firma Allievo</label>
                    <button type="button" onclick="clearCanvas()" class="text-xs text-red-500 hover:text-red-700 font-bold bg-red-50 px-2 py-1 rounded">
                        <i class="fa-solid fa-eraser"></i> Pulisci
                    </button>
                </div>
                <div class="relative border-2 border-dashed border-gray-300 rounded-lg bg-gray-50 h-48 w-full overflow-hidden" id="canvas-container" style="touch-action: none;">
                    <canvas id="signature-pad" class="w-full h-full block touch-none"></canvas>
                    <div class="absolute bottom-2 right-2 text-gray-300 text-xs pointer-events-none select-none">Firma qui</div>
                </div>
            </div>
        </div>

        <!-- Decorazione bordo "scontrino" -->
        <div class="receipt-edge"></div>
    </main>

    <!-- Pulsanti Azione -->
    <div class="w-full max-w-md space-y-3 mb-8">
        <button onclick="saveNote()" id="saveBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-lg shadow-lg flex items-center justify-center transition-all active:scale-95 text-lg">
            <span id="btnText"><i class="fa-solid fa-download mr-2"></i> Conferma e Salva Ricevuta</span>
            <span id="btnLoader" class="hidden"><i class="fa-solid fa-circle-notch fa-spin"></i> Elaborazione...</span>
        </button>
        
        <button onclick="resetForm()" class="w-full bg-white text-gray-600 font-semibold py-3 rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors">
            Nuova Guida
        </button>
    </div>

    <!-- Modal Successo -->
    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-xl p-6 text-center shadow-2xl max-w-xs mx-4 transform scale-95 transition-transform duration-300" id="modalContent">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600 text-3xl">
                <i class="fa-solid fa-check"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Salvato!</h3>
            <p class="text-gray-600 mb-6 text-sm">L'immagine della guida è stata scaricata sul dispositivo.</p>
            <button onclick="closeModal()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700">OK</button>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURAZIONE DATABASE ALLIEVI
        // ==========================================
        const DB_ALLIEVI = {
            "Colleferro": {
                "B": [
                    "Alice Crecco", "Alisia Pelacci", "Andrea Russo", "Angelica Gabrieli", "Angelica Matturro", 
                    "Angelica Mescia", "Anna Belli", "Arduini Edoardo", "Aurora Consilia Pecchi", "Aurora Gizzi", 
                    "Aurora Sozzi", "Beatrice Uras", "Bran Elisa", "Campagna Valerio", "Carrubino Erica", 
                    "Chiara Grieco", "Chima Samuele", "Collacchi Valerio", "Coluzzi Elena", "Cristal Turri", 
                    "Cristian Dragutinovic", "Daniele Mazzocchi", "De Felice Lonardo", "Denise Gabrielli", 
                    "Eleonora Santigli", "Fabrizio Ravelli", "Ferrante Martina", "Frattaroli Valeria", 
                    "Gagliarducci Valerio", "Gallo Noemi", "Giacomo Marcozzi", "Giada Vari", 
                    "Giorgia Mastrogiacomo", "Grazia Greco Maria", "Gregory Pezzella", "Greta Turco", 
                    "Iadarola Pietro", "Ilaria Ippoliti", "Ilaria Loreti", "Lavinia Proia", "Leo Veronica", 
                    "Lorenza Necci", "Lorenzo Stella", "Marchetti Valentina", "Maria Martina Priori", 
                    "Momodu Odidi", "Ricci Valerio", "Selene Sortoluzzi"
                ],
                "B1": ["Damiano Falcone", "Greta Testa", "Syria Testa"],
                "BS": ["Carrubino Erica"]
            },
            "Di Castro": {
                "Am": ["Luca Silvestri"]
            },
            "Genazzano": {
                "B": [
                    "Agnetelli Asia", "Alessio Luberti", "Alexandru Carp", "Amarilda Mataj", "Angelucci Lara", 
                    "Asia Maggi", "Bangrazi Kevin", "Beatrice Canini", "Bianchi Daniele", "Chiara Ronci", 
                    "Escalona Laura Piedra", "Evelin Gentili", "Gabriel Nita", "Lazzara Martina", 
                    "Massimiliano Rocca"
                ]
            },
            "La Maxima": {
                "A": ["Carlo Crescenzi", "Chiara Nicolia"]
            },
            "Palestrina": {
                "B": [
                    "Bernardini Giulia", "Boscaini Elena", "Chiara Trentini", "Dell'Orco Simone", 
                    "Romano Sara", "Ruggero Verrelli"
                ]
            },
            "Paliano": {
                "B": [
                    "Alexander Porfilio", "Antonio Terenzi", "Clara Tiroli", "Francesca Marucci", 
                    "Ippoliti Leonardo", "Lorenzo Verani", "Pacciani Virginia"
                ]
            }
        };

        // --- Logica Autocomplete Migliorata ---
        const studentInput = document.getElementById('studentName');
        const suggestionsList = document.getElementById('suggestions');
        
        // 1. Appiattire il DB conservando le info extra (Sede e Patente)
        function getStudentsData() {
            let allStudents = [];
            for (const sede in DB_ALLIEVI) {
                for (const patente in DB_ALLIEVI[sede]) {
                    const nomi = DB_ALLIEVI[sede][patente];
                    // Crea un oggetto per ogni studente con le info aggiuntive
                    const studentsWithInfo = nomi.map(name => ({
                        name: name,
                        sede: sede,
                        patente: patente
                    }));
                    allStudents = allStudents.concat(studentsWithInfo);
                }
            }
            // Ordina alfabeticamente per nome
            return allStudents.sort((a, b) => a.name.localeCompare(b.name));
        }

        const allStudentsData = getStudentsData();

        // 2. Event Listener Input
        studentInput.addEventListener('input', function() {
            const query = this.value.toLowerCase();
            suggestionsList.innerHTML = '';
            
            if (query.length < 2) { 
                suggestionsList.classList.add('hidden');
                return;
            }

            const matches = allStudentsData.filter(student => student.name.toLowerCase().includes(query));

            if (matches.length > 0) {
                matches.forEach(student => {
                    const li = document.createElement('li');
                    // Layout a due righe: Nome (grassetto) e sotto Sede - Patente (piccolo)
                    li.innerHTML = `
                        <div class="font-bold text-gray-800">${student.name}</div>
                        <div class="text-xs text-gray-500 uppercase tracking-wide">
                            <i class="fa-solid fa-location-dot mr-1"></i>${student.sede} 
                            <span class="mx-1 text-gray-300">|</span> 
                            <i class="fa-solid fa-id-card mr-1"></i>Pat. ${student.patente}
                        </div>
                    `;
                    li.className = "px-4 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-0";
                    
                    // Al click inserisce NOME - SEDE (Pat. X)
                    li.onclick = () => {
                        studentInput.value = `${student.name} - ${student.sede} (Pat. ${student.patente})`;
                        suggestionsList.classList.add('hidden');
                    };
                    suggestionsList.appendChild(li);
                });
                suggestionsList.classList.remove('hidden');
            } else {
                suggestionsList.classList.add('hidden');
            }
        });

        // Nascondi suggerimenti se si clicca fuori
        document.addEventListener('click', function(e) {
            if (!studentInput.contains(e.target) && !suggestionsList.contains(e.target)) {
                suggestionsList.classList.add('hidden');
            }
        });


        // --- Configurazione Data ---
        const dateInput = document.getElementById('driveDate');
        dateInput.value = new Date().toISOString().split('T')[0];

        // --- Logica Toggle Pagamento ---
        const paymentCheckbox = document.getElementById('paymentReceived');
        const amountContainer = document.getElementById('paymentAmountContainer');

        paymentCheckbox.addEventListener('change', function() {
            if(this.checked) {
                amountContainer.classList.remove('hidden');
                setTimeout(() => document.getElementById('paymentAmount').focus(), 100);
            } else {
                amountContainer.classList.add('hidden');
                document.getElementById('paymentAmount').value = "";
            }
        });

        // --- Logica Canvas (Firma) ---
        const canvas = document.getElementById('signature-pad');
        const container = document.getElementById('canvas-container');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let lastWidth = 0;

        function initCanvas() {
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#000000';
            lastWidth = window.innerWidth;
        }

        function handleResize() {
            if (window.innerWidth === lastWidth) return;
            const savedData = canvas.toDataURL();
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#000000';
            const img = new Image();
            img.src = savedData;
            img.onload = function() {
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            };
            lastWidth = window.innerWidth;
        }

        window.addEventListener('load', initCanvas);
        window.addEventListener('resize', handleResize);

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }

        function startDrawing(e) {
            isDrawing = true;
            const pos = getPos(e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        }

        function draw(e) {
            if (!isDrawing) return;
            if(e.cancelable) e.preventDefault(); 
            const pos = getPos(e);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
        }

        function stopDrawing() {
            isDrawing = false;
            ctx.beginPath();
        }

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        canvas.addEventListener('touchstart', startDrawing, { passive: false });
        canvas.addEventListener('touchmove', draw, { passive: false });
        canvas.addEventListener('touchend', stopDrawing);

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
        }

        // --- Logica Salvataggio ---
        function saveNote() {
            const studentName = document.getElementById('studentName').value;
            const selectedDate = document.getElementById('driveDate').value;
            
            if (!studentName) {
                alert("Inserisci il nome dell'allievo prima di salvare.");
                return;
            }

            const btn = document.getElementById('saveBtn');
            const btnText = document.getElementById('btnText');
            const btnLoader = document.getElementById('btnLoader');

            btn.disabled = true;
            btnText.classList.add('hidden');
            btnLoader.classList.remove('hidden');
            btn.classList.add('opacity-75');

            setTimeout(() => {
                const elementToCapture = document.getElementById('capture-area');
                
                html2canvas(elementToCapture, {
                    scale: 3,
                    backgroundColor: null,
                    logging: false,
                    useCORS: true,
                    onclone: (clonedDoc) => {
                        const inputs = clonedDoc.querySelectorAll('input');
                        inputs.forEach(input => {
                            if (input.id === 'driveDate') {
                                input.style.color = '#ffffff';
                            } else {
                                input.style.color = '#000000';
                                input.style.fontWeight = 'bold';
                            }
                        });
                        // Nascondi lista suggerimenti nel clone
                        const suggestions = clonedDoc.getElementById('suggestions');
                        if(suggestions) suggestions.style.display = 'none';
                        // Rimuovi icona lente nel clone se vuoi pulizia
                        const icon = clonedDoc.querySelector('.fa-magnifying-glass');
                        if(icon) icon.style.display = 'none';
                    }
                }).then(canvasResult => {
                    const link = document.createElement('a');
                    // Pulisce il nome file da caratteri speciali come parentesi
                    const safeName = studentName.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                    const dateStr = selectedDate || new Date().toISOString().split('T')[0];
                    
                    link.download = `guida_${safeName}_${dateStr}.png`;
                    link.href = canvasResult.toDataURL("image/png");
                    link.click();

                    showSuccessModal();

                    btn.disabled = false;
                    btnText.classList.remove('hidden');
                    btnLoader.classList.add('hidden');
                    btn.classList.remove('opacity-75');
                }).catch(err => {
                    console.error(err);
                    alert("Errore durante il salvataggio. Riprova.");
                    btn.disabled = false;
                    btnText.classList.remove('hidden');
                    btnLoader.classList.add('hidden');
                });
            }, 100);
        }

        function resetForm() {
            if(confirm("Sei sicuro di voler cancellare tutto e iniziare una nuova scheda?")) {
                document.getElementById('studentName').value = "";
                document.getElementById('driveDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('paymentReceived').checked = false;
                document.getElementById('paymentAmount').value = "";
                document.getElementById('paymentAmountContainer').classList.add('hidden');
                clearCanvas();
            }
        }

        const modal = document.getElementById('successModal');
        const modalContent = document.getElementById('modalContent');

        function showSuccessModal() {
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
                modalContent.classList.add('scale-100');
            }, 10);
        }

        function closeModal() {
            modal.classList.add('opacity-0');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }
    </script>
</body>
</html>